name: Deploy ÐšÐžÐ” Ð”Ð•ÐÐ•Ð“ 4.0 to Production

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to Production Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            echo "ðŸš€ Starting deployment..."

            # Navigate to project directory
            cd /var/www/hranitel || {
              echo "ðŸ“ Creating project directory..."
              mkdir -p /var/www/hranitel
              cd /var/www/hranitel
              git clone https://github.com/DaniilLepekhin/Hranitel-MiniApp.git .
            }

            # Pull latest changes
            echo "ðŸ“¥ Pulling latest code..."
            git fetch origin
            git reset --hard origin/main

            # Backend deployment
            echo "ðŸ”§ Deploying Backend..."
            cd backend

            # Create .env for backend (bot disabled, only webapp)
            echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" > .env
            echo "PORT=3002" >> .env
            echo "NODE_ENV=production" >> .env
            echo "WEBAPP_URL=https://hranitel.daniillepekhin.com" >> .env
            echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env
            echo "CORS_ORIGIN=https://hranitel.daniillepekhin.com" >> .env

            # Install Bun if not exists
            if ! command -v bun &> /dev/null; then
              echo "ðŸ“¦ Installing Bun..."
              curl -fsSL https://bun.sh/install | bash
              export BUN_INSTALL="$HOME/.bun"
              export PATH="$BUN_INSTALL/bin:$PATH"
            fi
            export BUN_INSTALL="$HOME/.bun"
            export PATH="$BUN_INSTALL/bin:$PATH"

            bun install

            # Restart backend service (port 3002)
            echo "ðŸ”„ Restarting backend..."
            pm2 delete hranitel-backend 2>/dev/null || true
            pm2 start --name hranitel-backend "bun run start"
            pm2 save

            # Frontend deployment
            echo "ðŸŽ¨ Deploying Frontend..."
            cd ../webapp

            # Create .env for production (API on same domain via /api/)
            echo "NEXT_PUBLIC_API_URL=/api" > .env.local

            # Install dependencies
            npm install

            # Build frontend
            echo "ðŸ—ï¸ Building frontend..."
            npm run build

            # Restart frontend service (port 3003)
            echo "ðŸ”„ Restarting frontend..."
            pm2 delete hranitel-frontend 2>/dev/null || true
            PORT=3003 pm2 start --name hranitel-frontend "npm run start"
            pm2 save

            # Setup Nginx for hranitel.daniillepekhin.com
            echo "ðŸŒ Configuring Nginx..."
            cat > /etc/nginx/sites-available/hranitel << 'NGINX_EOF'
            server {
                server_name hranitel.daniillepekhin.com;

                # Frontend (Next.js webapp) - port 3003
                location / {
                    proxy_pass http://localhost:3003;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade $http_upgrade;
                    proxy_set_header Connection 'upgrade';
                    proxy_set_header Host $host;
                    proxy_cache_bypass $http_upgrade;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                    proxy_read_timeout 300s;
                    proxy_connect_timeout 300s;
                    proxy_send_timeout 300s;
                }

                # Backend API - port 3002
                location /api/ {
                    proxy_pass http://localhost:3002/api/;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade $http_upgrade;
                    proxy_set_header Connection 'upgrade';
                    proxy_set_header Host $host;
                    proxy_cache_bypass $http_upgrade;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                    proxy_read_timeout 300s;
                    proxy_connect_timeout 300s;
                    proxy_send_timeout 300s;
                }

                # Health check
                location /health {
                    proxy_pass http://localhost:3002/health;
                    proxy_http_version 1.1;
                    proxy_set_header Host $host;
                }

                listen 80;
            }
            NGINX_EOF

            ln -sf /etc/nginx/sites-available/hranitel /etc/nginx/sites-enabled/
            nginx -t && systemctl reload nginx

            # Setup SSL with Certbot
            echo "ðŸ” Setting up SSL..."
            certbot --nginx -d hranitel.daniillepekhin.com --non-interactive --agree-tos --email admin@daniillepekhin.com || echo "âš ï¸ SSL setup skipped (may need DNS first)"

            echo ""
            echo "âœ… Deployment completed!"
            echo "ðŸŒ Frontend: https://hranitel.daniillepekhin.com"
            echo "ðŸ”Œ Backend API: https://hranitel.daniillepekhin.com/api/"
            echo ""
            pm2 status

      - name: Notify Deployment Status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "âœ… Deployment successful!"
          else
            echo "âŒ Deployment failed!"
          fi
