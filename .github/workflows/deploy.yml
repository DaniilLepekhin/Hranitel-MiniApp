name: Deploy ĞšĞĞ” Ğ”Ğ•ĞĞ•Ğ“ 4.0 to Production

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to Production Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            echo "ğŸš€ Starting deployment..."

            # Navigate to project directory
            cd /var/www/hranitel || {
              echo "ğŸ“ Creating project directory..."
              mkdir -p /var/www/hranitel
              cd /var/www/hranitel
              git clone https://github.com/DaniilLepekhin/Hranitel-MiniApp.git .
            }

            # Pull latest changes
            echo "ğŸ“¥ Pulling latest code..."
            git fetch origin
            git reset --hard origin/main

            # Backend deployment
            echo "ğŸ”§ Deploying Backend..."
            cd backend

            # Install dependencies
            if ! command -v bun &> /dev/null; then
              echo "ğŸ“¦ Installing Bun..."
              curl -fsSL https://bun.sh/install | bash
              export BUN_INSTALL="$HOME/.bun"
              export PATH="$BUN_INSTALL/bin:$PATH"
            fi

            bun install

            # Run migrations
            echo "ğŸ—„ï¸ Running database migrations..."
            bun run db:push || echo "âš ï¸ Migrations skipped (may already be applied)"

            # Seed data if needed
            echo "ğŸŒ± Seeding shop data..."
            bun run tsx src/db/seeds/shop.ts || echo "âš ï¸ Seed skipped (may already exist)"

            # Restart backend service
            echo "ğŸ”„ Restarting backend..."
            pm2 delete kod-deneg-backend || true
            pm2 start --name kod-deneg-backend "bun run start"
            pm2 save

            # Frontend deployment
            echo "ğŸ¨ Deploying Frontend..."
            cd ../webapp

            # Create .env for production (API on same domain via /api/)
            echo "NEXT_PUBLIC_API_URL=/api" > .env.local

            # Install dependencies
            npm install

            # Build frontend
            echo "ğŸ—ï¸ Building frontend..."
            npm run build

            # Restart frontend service
            echo "ğŸ”„ Restarting frontend..."
            pm2 delete kod-deneg-frontend || true
            pm2 start --name kod-deneg-frontend "npm run start"
            pm2 save

            # Setup Nginx - single domain with /api/ path
            echo "ğŸŒ Configuring Nginx..."
            cat > /etc/nginx/sites-available/hranitel << 'NGINX_EOF'
# Single domain: hranitel.daniillepekhin.com
# Frontend: /
# Backend API: /api/
server {
    listen 80;
    server_name hranitel.daniillepekhin.com;

    # Backend API - proxy /api/* to port 3001
    location /api/ {
        proxy_pass http://localhost:3001/api/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Frontend WebApp - everything else to port 3000
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
NGINX_EOF

            ln -sf /etc/nginx/sites-available/hranitel /etc/nginx/sites-enabled/
            nginx -t && systemctl reload nginx

            # Setup SSL with Certbot (Let's Encrypt)
            if ! command -v certbot &> /dev/null; then
              echo "ğŸ” Installing Certbot..."
              apt-get update
              apt-get install -y certbot python3-certbot-nginx
            fi

            # Get SSL certificate for single domain
            certbot --nginx -d hranitel.daniillepekhin.com --non-interactive --agree-tos --email admin@daniillepekhin.com || echo "âš ï¸ SSL setup skipped"

            echo "âœ… Deployment completed successfully!"
            echo ""
            echo "ğŸŒ Frontend: https://hranitel.daniillepekhin.com"
            echo "ğŸ”Œ Backend API: https://hranitel.daniillepekhin.com/api/"
            echo ""
            pm2 status

      - name: Notify Deployment Status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "âœ… Deployment successful!"
          else
            echo "âŒ Deployment failed!"
          fi
