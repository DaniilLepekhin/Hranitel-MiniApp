name: Deploy ĞšĞĞ” Ğ”Ğ•ĞĞ•Ğ“ 4.0 to Production

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to Production Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script_stop: true
          command_timeout: 10m
          script: |
            echo "ğŸš€ Starting deployment..."

            # Navigate to project directory
            cd /var/www/hranitel || {
              echo "ğŸ“ Creating project directory..."
              mkdir -p /var/www/hranitel
              cd /var/www/hranitel
              git clone https://github.com/DaniilLepekhin/Hranitel-MiniApp.git .
            }

            # Pull latest changes
            echo "ğŸ“¥ Pulling latest code..."
            git fetch origin
            git reset --hard origin/main

            # Backend deployment
            echo "ğŸ”§ Deploying Backend..."
            cd backend

            # Create .env for backend (bot disabled, only webapp)
            echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" > .env
            echo "PORT=3002" >> .env
            echo "NODE_ENV=production" >> .env
            echo "WEBAPP_URL=https://hranitel.daniillepekhin.com" >> .env
            echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env
            echo "CORS_ORIGIN=https://hranitel.daniillepekhin.com" >> .env
            echo "TELEGRAM_BOT_TOKEN=" >> .env
            echo "OPENAI_API_KEY=" >> .env

            # Install Bun if not exists
            if ! command -v bun &> /dev/null; then
              echo "ğŸ“¦ Installing Bun..."
              curl -fsSL https://bun.sh/install | bash
              export BUN_INSTALL="$HOME/.bun"
              export PATH="$BUN_INSTALL/bin:$PATH"
            fi
            export BUN_INSTALL="$HOME/.bun"
            export PATH="$BUN_INSTALL/bin:$PATH"

            bun install

            # Restart backend service (port 3002)
            echo "ğŸ”„ Restarting backend..."
            pm2 delete hranitel-backend 2>/dev/null || true
            pm2 start --name hranitel-backend "$HOME/.bun/bin/bun run src/index.ts"
            pm2 save

            # Frontend deployment
            echo "ğŸ¨ Deploying Frontend..."
            cd ../webapp

            # Create .env for production (API on same domain via /api/)
            echo "NEXT_PUBLIC_API_URL=" > .env.local

            # Install dependencies
            npm install

            # Build frontend
            echo "ğŸ—ï¸ Building frontend..."
            npm run build

            # Restart frontend service (port 3003)
            echo "ğŸ”„ Restarting frontend..."
            pm2 delete hranitel-frontend 2>/dev/null || true
            PORT=3003 pm2 start --name hranitel-frontend "npm run start"
            pm2 save

            # Setup Nginx for hranitel.daniillepekhin.com
            echo "ğŸŒ Configuring Nginx..."
            printf 'server {\n    server_name hranitel.daniillepekhin.com;\n    location / {\n        proxy_pass http://localhost:3003;\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection upgrade;\n        proxy_set_header Host $host;\n        proxy_cache_bypass $http_upgrade;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n        proxy_read_timeout 300s;\n        proxy_connect_timeout 300s;\n        proxy_send_timeout 300s;\n    }\n    location /api/ {\n        proxy_pass http://localhost:3002/api/;\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection upgrade;\n        proxy_set_header Host $host;\n        proxy_cache_bypass $http_upgrade;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n        proxy_read_timeout 300s;\n        proxy_connect_timeout 300s;\n        proxy_send_timeout 300s;\n    }\n    location /health {\n        proxy_pass http://localhost:3002/health;\n        proxy_http_version 1.1;\n        proxy_set_header Host $host;\n    }\n    listen 80;\n}\n' > /etc/nginx/sites-available/hranitel

            ln -sf /etc/nginx/sites-available/hranitel /etc/nginx/sites-enabled/
            nginx -t && systemctl reload nginx

            # Setup SSL with Certbot
            echo "ğŸ” Setting up SSL..."
            certbot --nginx -d hranitel.daniillepekhin.com --non-interactive --agree-tos --email admin@daniillepekhin.com 2>/dev/null || echo "âš ï¸ SSL setup skipped (may need DNS first)"

            echo ""
            echo "âœ… Deployment completed!"
            echo "ğŸŒ Frontend: https://hranitel.daniillepekhin.com"
            echo "ğŸ”Œ Backend API: https://hranitel.daniillepekhin.com/api/"
            echo ""
            pm2 status

      - name: Notify Deployment Status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "âœ… Deployment successful!"
          else
            echo "âŒ Deployment failed!"
          fi
