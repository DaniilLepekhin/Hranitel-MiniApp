name: Deploy –ö–û–î –î–ï–ù–ï–ì 4.0 to Production

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to Production Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script_stop: true
          command_timeout: 10m
          script: |
            echo "üöÄ Starting deployment..."

            # Navigate to project directory
            cd /var/www/hranitel || {
              echo "üìÅ Creating project directory..."
              mkdir -p /var/www/hranitel
              cd /var/www/hranitel
              git clone https://github.com/DaniilLepekhin/Hranitel-MiniApp.git .
            }

            # Pull latest changes
            echo "üì• Pulling latest code..."
            git fetch origin
            git reset --hard origin/main

            # Backend deployment
            echo "üîß Deploying Backend..."
            cd backend

            # Export environment variables (for migrations and health checks)
            export DATABASE_URL="${{ secrets.DATABASE_URL }}"
            export JWT_SECRET="${{ secrets.JWT_SECRET }}"
            export REDIS_URL="${{ secrets.REDIS_URL }}"
            export PORT="3002"
            export NODE_ENV="production"
            export WEBAPP_URL="https://hranitel.daniillepekhin.com"
            export CORS_ORIGIN="https://hranitel.daniillepekhin.com"
            export TELEGRAM_BOT_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}"
            export API_URL="https://hranitel.daniillepekhin.com"
            export TELEGRAM_WEBHOOK_SECRET="${{ secrets.TELEGRAM_WEBHOOK_SECRET }}"
            export TELEGRAM_BOT_USERNAME="${{ secrets.TELEGRAM_BOT_USERNAME }}"
            export OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}"

            # Also create .env file for PM2 persistence (Bun auto-loads .env)
            echo "DATABASE_URL=$DATABASE_URL" > .env
            echo "PORT=$PORT" >> .env
            echo "NODE_ENV=$NODE_ENV" >> .env
            echo "WEBAPP_URL=$WEBAPP_URL" >> .env
            echo "JWT_SECRET=$JWT_SECRET" >> .env
            echo "CORS_ORIGIN=$CORS_ORIGIN" >> .env
            echo "TELEGRAM_BOT_TOKEN=$TELEGRAM_BOT_TOKEN" >> .env
            echo "API_URL=$API_URL" >> .env
            echo "TELEGRAM_WEBHOOK_SECRET=$TELEGRAM_WEBHOOK_SECRET" >> .env
            echo "TELEGRAM_BOT_USERNAME=$TELEGRAM_BOT_USERNAME" >> .env
            echo "REDIS_URL=$REDIS_URL" >> .env
            echo "OPENAI_API_KEY=$OPENAI_API_KEY" >> .env

            # Install Bun if not exists
            if ! command -v bun &> /dev/null; then
              echo "üì¶ Installing Bun..."
              curl -fsSL https://bun.sh/install | bash
              export BUN_INSTALL="$HOME/.bun"
              export PATH="$BUN_INSTALL/bin:$PATH"
            fi
            export BUN_INSTALL="$HOME/.bun"
            export PATH="$BUN_INSTALL/bin:$PATH"

            # Clear Bun cache
            rm -rf node_modules
            rm -rf .bun-cache

            bun install

            # üîß Run ALL database migrations (including new ones 0004, 0005)
            echo "üìä Running database migrations..."
            cd /var/www/hranitel/backend

            # Apply migration 0003 (if not already applied)
            echo "üìä Checking migration 0003..."
            psql "$DATABASE_URL" -c "SELECT 1 FROM gift_subscriptions LIMIT 1" 2>/dev/null || {
              echo "üìä Applying migration 0003_add_onboarding_and_gift_fields.sql..."
              psql "$DATABASE_URL" -f drizzle/migrations/0003_add_onboarding_and_gift_fields.sql
            }

            # Apply migration 0004 (payments table)
            echo "üìä Checking migration 0004..."
            psql "$DATABASE_URL" -c "SELECT 1 FROM payments LIMIT 1" 2>/dev/null || {
              echo "üìä Applying migration 0004_create_payments_table.sql..."
              psql "$DATABASE_URL" -f drizzle/migrations/0004_create_payments_table.sql
              echo "‚úÖ Payments table created"
            }

            # Apply migration 0005 (performance indexes + materialized views)
            echo "üìä Checking migration 0005..."
            psql "$DATABASE_URL" -c "SELECT 1 FROM city_ratings_cache LIMIT 1" 2>/dev/null || {
              echo "üìä Applying migration 0005_add_performance_indexes_and_views.sql..."
              psql "$DATABASE_URL" -f drizzle/migrations/0005_add_performance_indexes_and_views.sql
              echo "‚úÖ Performance indexes and materialized views created"

              # Initial refresh of materialized views
              echo "üîÑ Initial refresh of materialized views..."
              psql "$DATABASE_URL" -c "SELECT refresh_ratings_cache();"
            }

            # Apply migration 0006 (club funnel progress table)
            echo "üìä Checking migration 0006..."
            psql "$DATABASE_URL" -c "SELECT 1 FROM club_funnel_progress LIMIT 1" 2>/dev/null || {
              echo "üìä Applying migration 0006_add_club_funnel_progress.sql..."
              psql "$DATABASE_URL" -f drizzle/migrations/0006_add_club_funnel_progress.sql
              echo "‚úÖ Club funnel progress table created"
            }

            # Apply migration 0007 (add chislo column - uses IF NOT EXISTS, safe to run multiple times)
            echo "üìä Applying migration 0007_add_chislo_to_club_funnel.sql..."
            psql "$DATABASE_URL" -f drizzle/migrations/0007_add_chislo_to_club_funnel.sql && echo "‚úÖ Migration 0007 completed"

            # Apply migration 0011 (add city_chat_id to users - uses IF NOT EXISTS, safe to run multiple times)
            echo "üìä Applying migration 0011_add_city_chat_id_to_users.sql..."
            psql "$DATABASE_URL" -f drizzle/migrations/0011_add_city_chat_id_to_users.sql && echo "‚úÖ Migration 0011 completed"

            echo "‚úÖ All migrations applied successfully!"

            # üîç Pre-deployment health check
            echo "üîç Running pre-deployment health checks..."

            # Check database connection
            psql "$DATABASE_URL" -c "SELECT 1" > /dev/null && echo "‚úÖ Database connection OK" || {
              echo "‚ùå Database connection FAILED"
              exit 1
            }

            # Check Redis connection
            redis-cli ping > /dev/null && echo "‚úÖ Redis connection OK" || echo "‚ö†Ô∏è Redis not available (optional)"

            # Backup current backend process (for rollback)
            echo "üíæ Creating backup of current backend..."
            pm2 save --force

            # Restart backend service (port 3002)
            echo "üîÑ Restarting backend..."
            pm2 delete hranitel-backend 2>/dev/null || true
            cd /var/www/hranitel/backend

            # Use ecosystem file for proper env loading
            pm2 start ecosystem.config.cjs
            pm2 save

            # Wait for backend to start
            echo "‚è≥ Waiting for backend to start..."
            sleep 5

            # üè• Post-deployment health check
            echo "üè• Running post-deployment health checks..."

            # Check backend health endpoint
            HEALTH_CHECK=$(curl -s http://localhost:3002/health || echo "FAILED")
            if echo "$HEALTH_CHECK" | grep -q "ok"; then
              echo "‚úÖ Backend health check PASSED"
            else
              echo "‚ùå Backend health check FAILED"
              echo "üîÑ Rolling back to previous version..."
              pm2 resurrect
              exit 1
            fi

            # Check backend readiness (DB + Redis)
            READY_CHECK=$(curl -s http://localhost:3002/health/ready || echo "FAILED")
            if echo "$READY_CHECK" | grep -q "ready"; then
              echo "‚úÖ Backend readiness check PASSED"
            else
              echo "‚ö†Ô∏è Backend not fully ready (DB or Redis issue)"
              echo "Response: $READY_CHECK"
            fi

            # Check scheduler queue size
            QUEUE_SIZE=$(redis-cli ZCARD scheduler:queue 2>/dev/null || echo "0")
            echo "üìä Scheduler queue size: $QUEUE_SIZE tasks"
            if [ "$QUEUE_SIZE" -gt 1000 ]; then
              echo "‚ö†Ô∏è WARNING: Large scheduler queue detected!"
            fi

            # Frontend deployment
            echo "üé® Deploying Frontend..."
            cd ../webapp

            # Remove .env.local to use .env.production from repo
            rm -f .env.local

            # Clean npm cache and node_modules
            echo "üßπ Cleaning npm cache..."
            rm -rf node_modules .next
            npm cache clean --force

            # Install dependencies (including devDependencies for TypeScript)
            npm install --include=dev

            # Build frontend
            echo "üèóÔ∏è Building frontend..."
            npm run build

            # Copy static files for standalone mode (required by Next.js)
            echo "üì¶ Copying static files..."
            cp -r .next/static .next/standalone/.next/static
            cp -r public .next/standalone/public

            # Restart frontend service (port 3003)
            echo "üîÑ Restarting frontend..."
            pm2 delete hranitel-frontend 2>/dev/null || true
            cd .next/standalone
            PORT=3003 pm2 start --name hranitel-frontend --cwd /var/www/hranitel/webapp/.next/standalone node -- server.js
            pm2 save

            # Setup Nginx for hranitel.daniillepekhin.com
            echo "üåê Configuring Nginx..."
            printf 'server {\n    server_name hranitel.daniillepekhin.com;\n    location / {\n        proxy_pass http://localhost:3003;\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection upgrade;\n        proxy_set_header Host $host;\n        proxy_cache_bypass $http_upgrade;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n        proxy_read_timeout 300s;\n        proxy_connect_timeout 300s;\n        proxy_send_timeout 300s;\n    }\n    location /api/ {\n        proxy_pass http://localhost:3002/api/;\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection upgrade;\n        proxy_set_header Host $host;\n        proxy_cache_bypass $http_upgrade;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n        proxy_read_timeout 300s;\n        proxy_connect_timeout 300s;\n        proxy_send_timeout 300s;\n    }\n    location /health {\n        proxy_pass http://localhost:3002/health;\n        proxy_http_version 1.1;\n        proxy_set_header Host $host;\n    }\n    listen 80;\n}\n' > /etc/nginx/sites-available/hranitel

            ln -sf /etc/nginx/sites-available/hranitel /etc/nginx/sites-enabled/
            nginx -t && systemctl reload nginx

            # Setup SSL with Certbot
            echo "üîê Setting up SSL..."
            certbot --nginx -d hranitel.daniillepekhin.com --non-interactive --agree-tos --email admin@daniillepekhin.com 2>/dev/null || echo "‚ö†Ô∏è SSL setup skipped (may need DNS first)"

            # üìä Final deployment report
            echo ""
            echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
            echo "‚úÖ DEPLOYMENT COMPLETED SUCCESSFULLY!"
            echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
            echo ""
            echo "üåê Frontend: https://hranitel.daniillepekhin.com"
            echo "üîå Backend API: https://hranitel.daniillepekhin.com/api/"
            echo "üè• Health Check: https://hranitel.daniillepekhin.com/health"
            echo "üè• Readiness Check: https://hranitel.daniillepekhin.com/health/ready"
            echo ""
            echo "üìä Database Status:"
            psql "$DATABASE_URL" -c "SELECT COUNT(*) as total_users FROM users;" | head -3 | tail -1 | xargs echo "Total users:"
            echo ""
            echo "üìä Scheduler Status:"
            echo "Queue size: $(redis-cli ZCARD scheduler:queue 2>/dev/null || echo 'Redis not available')"
            echo ""
            echo "üîÑ PM2 Processes:"
            pm2 status
            echo ""
            echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"

      - name: Setup Cron Job for Materialized Views
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script_stop: false
          command_timeout: 2m
          script: |
            echo "üïê Setting up cron job for materialized views..."

            # Create refresh script
            cat > /usr/local/bin/refresh_ratings.sh << 'EOFSCRIPT'
            #!/bin/bash
            if [ -f /var/www/hranitel/backend/.env ]; then
              export $(grep DATABASE_URL /var/www/hranitel/backend/.env | xargs)
            fi
            psql "$DATABASE_URL" -c "SELECT refresh_ratings_cache();" >> /var/log/ratings_refresh.log 2>&1
            echo "$(date '+%Y-%m-%d %H:%M:%S') - Refresh completed with status $?" >> /var/log/ratings_refresh.log
            EOFSCRIPT

            chmod +x /usr/local/bin/refresh_ratings.sh

            # Add to crontab
            CRON_LINE="5 * * * * /usr/local/bin/refresh_ratings.sh"
            (crontab -l 2>/dev/null | grep -q "/usr/local/bin/refresh_ratings.sh") || {
              (crontab -l 2>/dev/null; echo "$CRON_LINE") | crontab -
              echo "‚úÖ Cron job added"
            }

            echo "‚úÖ Cron setup completed"

      - name: Notify Deployment Status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "‚úÖ Deployment successful!"
          else
            echo "‚ùå Deployment failed!"
          fi
