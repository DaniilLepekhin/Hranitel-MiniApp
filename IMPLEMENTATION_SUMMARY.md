# üéØ –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ü–æ—Å—Ç-–æ–ø–ª–∞—Ç–Ω–æ–π –í–æ—Ä–æ–Ω–∫–∏ - –ü–æ–ª–Ω—ã–π –û—Ç—á–µ—Ç

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ

### 1. –ë–∞–∑–∞ –î–∞–Ω–Ω—ã—Ö
**–§–∞–π–ª:** `/backend/drizzle/migrations/0003_add_onboarding_and_gift_fields.sql`

–°–æ–∑–¥–∞–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è —Å:
- 4 –Ω–æ–≤—ã—Ö –ø–æ–ª—è –≤ —Ç–∞–±–ª–∏—Ü–µ `users`:
  - `first_purchase_date` - –¥–∞—Ç–∞ –ø–µ—Ä–≤–æ–π –ø–æ–∫—É–ø–∫–∏ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –¥–Ω–µ–π –≤ –∫–ª—É–±–µ
  - `gifted` - —Ñ–ª–∞–≥, –ø–æ–ª—É—á–µ–Ω–∞ –ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞ –≤ –ø–æ–¥–∞—Ä–æ–∫
  - `gifted_by` - telegram_id –¥–∞—Ä–∏—Ç–µ–ª—è
  - `onboarding_step` - —Ç–µ–∫—É—â–∏–π —à–∞–≥ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞

- –ù–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ `gift_subscriptions`:
  - –•—Ä–∞–Ω–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–¥–∞—Ä–æ—á–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–∫–∞—Ö
  - –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
  - –°–≤—è–∑—å —Å –ø–ª–∞—Ç–µ–∂–∞–º–∏ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
  - –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞

### 2. Schema TypeScript
**–§–∞–π–ª:** `/backend/src/db/schema.ts`

–û–±–Ω–æ–≤–ª–µ–Ω—ã –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è:
- –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è onboarding –≤ —Å—Ö–µ–º—É `users` (—Å—Ç—Ä–æ–∫–∏ 39-50)
- –°–æ–∑–¥–∞–Ω–∞ —Å—Ö–µ–º–∞ `giftSubscriptions` —Å –∏–Ω–¥–µ–∫—Å–∞–º–∏ (—Å—Ç—Ä–æ–∫–∏ 497-511)
- –¢–∏–ø–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–π –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞

### 3. –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ Scheduler Service
**–§–∞–π–ª:** `/backend/src/services/scheduler.service.ts`

–î–æ–±–∞–≤–ª–µ–Ω—ã 18 –Ω–æ–≤—ã—Ö —Ç–∏–ø–æ–≤ –∑–∞–¥–∞—á:
- **Keyword reminders:** `keyword_reminder_20m/60m/120m`
- **Ready button reminders:** `ready_reminder_30m/60m`, `ready_final_120m`
- **Engagement funnel:** `day1_gift_promo`, `day7/14/21/28_check_in`
- **Renewal reminders:** `renewal_2days/1day/today`
- **Gift expiry reminders:** `gift_expiry_3days/2days/1day`

### 4. –£—Ç–∏–ª–∏—Ç–∞ –ú–æ—Å–∫–æ–≤—Å–∫–æ–≥–æ –í—Ä–µ–º–µ–Ω–∏
**–§–∞–π–ª:** `/backend/src/utils/moscow-time.ts`

–°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –º–æ–¥—É–ª—å —Å —Ñ—É–Ω–∫—Ü–∏—è–º–∏:
- `getMoscowTimeTimestamp()` - —Ä–∞—Å—á–µ—Ç timestamp –≤ –ú–°–ö (UTC+3)
- `getMoscowTimeInDays()` - timestamp —á–µ—Ä–µ–∑ N –¥–Ω–µ–π –≤ –∑–∞–¥–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è –ú–°–ö
- `getTomorrowMoscowTime()` - –∑–∞–≤—Ç—Ä–∞ –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è –ú–°–ö
- `getDelayUntilMoscowTime()` - –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–æ —Ü–µ–ª–µ–≤–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –ú–°–ö

### 5. –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –í–æ—Ä–æ–Ω–æ–∫
**–§–∞–π–ª:** `/backend/src/modules/bot/post-payment-funnels.ts` (~800 —Å—Ç—Ä–æ–∫)

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –≤—Å–µ 7 –≤–æ—Ä–æ–Ω–æ–∫:

#### –í–æ—Ä–æ–Ω–∫–∞ 1: –ö–æ–¥–æ–≤–æ–µ —Å–ª–æ–≤–æ "–£–°–ü–ï–•"
- `startOnboardingAfterPayment()` - –∑–∞–ø—É—Å–∫ –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ
- `sendKeywordReminder20m/60m/120m()` - –¥–æ–≥—Ä–µ–≤—ã —á–µ—Ä–µ–∑ 20, 80, 200 –º–∏–Ω—É—Ç
- `handleKeywordSuccess()` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤–≤–æ–¥–∞

#### –í–æ—Ä–æ–Ω–∫–∞ 2: –ö–Ω–æ–ø–∫–∞ "–ì–û–¢–û–í–û"
- `sendReadyReminder30m/60m()` - –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è —á–µ—Ä–µ–∑ 30, 90 –º–∏–Ω—É—Ç
- `sendReadyFinal120m()` - —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —á–µ—Ä–µ–∑ 210 –º–∏–Ω—É—Ç
- `completeOnboarding()` - –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞

#### –í–æ—Ä–æ–Ω–∫–∞ 3: –ú–µ–Ω—é /menu
- `sendMenuMessage()` - –æ—Ç–ø—Ä–∞–≤–∫–∞ –º–µ–Ω—é —Å –∫–Ω–æ–ø–∫–∞–º–∏
- –ù–∞–≤–∏–≥–∞—Ü–∏—è: –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è, –¥–æ—Å—Ç—É–ø –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, –∫–∞–Ω–∞–ª—ã, –¥–æ–∫—É–º–µ–Ω—Ç—ã

#### –í–æ—Ä–æ–Ω–∫–∞ 4: –í–æ–≤–ª–µ—á–µ–Ω–∏–µ –ø–æ –¥–Ω—è–º
- `scheduleEngagementFunnel()` - –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- `sendDay1GiftPromo()` - –¥–µ–Ω—å 1 –≤ 10:00 –ú–°–ö (–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø–æ–¥–∞—Ä–∏—Ç—å)
- `sendDay7/14/21/28CheckIn()` - –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–≤—è–∑–∏ –≤ –¥–Ω–∏ 7, 14, 21, 28 –≤ 9:00 –ú–°–ö

#### –í–æ—Ä–æ–Ω–∫–∞ 5: –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –ø—Ä–æ–¥–ª–µ–Ω–∏–∏
- `sendRenewal2Days/1Day/Today()` - –∑–∞ 2 –¥–Ω—è, –∑–∞ 1 –¥–µ–Ω—å, –≤ –¥–µ–Ω—å –æ–∫–æ–Ω—á–∞–Ω–∏—è

#### –í–æ—Ä–æ–Ω–∫–∞ 6: –ü–æ–¥–∞—Ä–æ—á–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞
- `handleUserShared()` - –≤—ã–±–æ—Ä –¥—Ä—É–≥–∞ —á–µ—Ä–µ–∑ KeyboardButtonRequestUsers
- `handleGiftPaymentSuccess()` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ–ø–ª–∞—Ç—ã –ø–æ–¥–∞—Ä–∫–∞
- `handleGiftActivation()` - –∞–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ —É–Ω–∏–∫–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–µ
- `activateGiftForUser()` - –≤—ã–¥–∞—á–∞ –¥–æ—Å—Ç—É–ø–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª—é

#### –í–æ—Ä–æ–Ω–∫–∞ 7: –ò—Å—Ç–µ—á–µ–Ω–∏–µ –ø–æ–¥–∞—Ä–æ—á–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏
- `sendGiftExpiry3Days/2Days/1Day()` - –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –∑–∞ 3, 2, 1 –¥–µ–Ω—å

### 6. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –ë–æ—Ç–∞
**–§–∞–π–ª:** `/backend/src/modules/bot/index.ts`

–î–æ–±–∞–≤–ª–µ–Ω–æ:
- **–ò–º–ø–æ—Ä—Ç** funnel –º–æ–¥—É–ª—è (—Å—Ç—Ä–æ–∫–∞ 13)
- **18 –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤** –≤ `processScheduledTask()` (—Å—Ç—Ä–æ–∫–∏ 369-393)
- **–ó–∞–ø—É—Å–∫ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞** –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã (—Å—Ç—Ä–æ–∫–∏ 528-532)
- **–û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ /start** —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π gift-—Å—Å—ã–ª–æ–∫ (—Å—Ç—Ä–æ–∫–∏ 412-418)
- **–ù–æ–≤–∞—è –∫–æ–º–∞–Ω–¥–∞ /menu** (—Å—Ç—Ä–æ–∫–∏ 983-992)

#### –ù–æ–≤—ã–µ Callback Queries:
- `onboarding_ready` - –∫–Ω–æ–ø–∫–∞ "–ì–û–¢–û–í–û" (—Å—Ç—Ä–æ–∫–∏ 727-737)
- `gift_subscription` - –Ω–∞—á–∞–ª–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –¥–∞—Ä–µ–Ω–∏—è (—Å—Ç—Ä–æ–∫–∏ 740-770)
- `gift_start` / `gift_continue` - –∞–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ–¥–∞—Ä–∫–∞ (—Å—Ç—Ä–æ–∫–∏ 773-800)
- `menu_back` - –≤–æ–∑–≤—Ä–∞—Ç –≤ –º–µ–Ω—é (—Å—Ç—Ä–æ–∫–∏ 803-813)
- `menu_instruction` - –ø–æ–∫–∞–∑ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ (—Å—Ç—Ä–æ–∫–∏ 816-831)

#### –ù–æ–≤—ã–µ Message Handlers:
- `message:text` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–æ–≤–æ–≥–æ —Å–ª–æ–≤–∞ "–£–°–ü–ï–•" (—Å—Ç—Ä–æ–∫–∏ 1174-1186)
- `message:users_shared` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –¥—Ä—É–≥–∞ –¥–ª—è –ø–æ–¥–∞—Ä–∫–∞ (—Å—Ç—Ä–æ–∫–∏ 1189-1208)

#### –û–±–Ω–æ–≤–ª–µ–Ω–∏—è Webhook:
- –î–æ–±–∞–≤–ª–µ–Ω `users_shared` –≤ `allowed_updates` (—Å—Ç—Ä–æ–∫–∞ 1274)

---

## üìã –ß—Ç–æ –ù—É–∂–Ω–æ –°–¥–µ–ª–∞—Ç—å –î–∞–ª—å—à–µ

### 1. –ó–∞–ø—É—Å–∫ –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î
```bash
cd /Users/daniillepekhin/My\ Python/egiazarova/club_webapp/backend
bun run db:migrate
```

–ò–ª–∏ –≤—Ä—É—á–Ω—É—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:
```bash
psql -U your_user -d your_database -f drizzle/migrations/0003_add_onboarding_and_gift_fields.sql
```

### 2. –õ–æ–∫–∞–ª—å–Ω–æ–µ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**–ü—Ä–æ–≤–µ—Ä–∏—Ç—å:**
- ‚úÖ –°—Ç–∞—Ä—Ç –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã
- ‚úÖ –î–æ–≥—Ä–µ–≤—ã –ø–æ keyword "–£–°–ü–ï–•" (20, 80, 200 –º–∏–Ω)
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ "–£–°–ü–ï–•"
- ‚úÖ –î–æ–≥—Ä–µ–≤—ã –ø–æ –∫–Ω–æ–ø–∫–µ "–ì–û–¢–û–í–û" (30, 90, 210 –º–∏–Ω)
- ‚úÖ –ù–∞–∂–∞—Ç–∏–µ "–ì–û–¢–û–í–û" –∏ –ø–µ—Ä–µ—Ö–æ–¥ –∫ –º–µ–Ω—é
- ‚úÖ –ö–æ–º–∞–Ω–¥–∞ /menu –∏ –Ω–∞–≤–∏–≥–∞—Ü–∏—è
- ‚úÖ –î–µ–Ω—å 1: –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø–æ–¥–∞—Ä–∫–∞ (10:00 –ú–°–ö)
- ‚úÖ –î–Ω–∏ 7/14/21/28: check-in —Å–æ–æ–±—â–µ–Ω–∏—è (9:00 –ú–°–ö)
- ‚úÖ –í—ã–±–æ—Ä –¥—Ä—É–≥–∞ —á–µ—Ä–µ–∑ KeyboardButtonRequestUsers
- ‚úÖ –û–ø–ª–∞—Ç–∞ –ø–æ–¥–∞—Ä–∫–∞ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞
- ‚úÖ –ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ–¥–∞—Ä–∫–∞ –ø–æ —Å—Å—ã–ª–∫–µ `/start gift_{token}`
- ‚úÖ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –ø—Ä–æ–¥–ª–µ–Ω–∏–∏ (–∑–∞ 2, 1, 0 –¥–Ω–µ–π)
- ‚úÖ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ–± –∏—Å—Ç–µ—á–µ–Ω–∏–∏ –ø–æ–¥–∞—Ä–∫–∞ (–∑–∞ 3, 2, 1 –¥–µ–Ω—å)

### 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ö–æ–Ω—Ç–µ–Ω—Ç–∞

**–ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ (–±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–∑–∂–µ):**
- –í–∏–¥–µ–æ-–∫—Ä—É–∂–æ–∫ –≤ –ø–µ—Ä–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ (—Å—Ç—Ä–æ–∫–∞ 4 –¢–ó)
- –í–∏–¥–µ–æ-–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –≤ –º–µ–Ω—é (—Å—Ç—Ä–æ–∫–∞ 92 –¢–ó)

**–í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è:**
- –í–º–µ—Å—Ç–æ –≤–∏–¥–µ–æ-–∫—Ä—É–∂–∫–∞: —Ç–µ–∫—Å—Ç + –∫–Ω–æ–ø–∫–∞
- –í–º–µ—Å—Ç–æ –≤–∏–¥–µ–æ-–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏: –∑–∞–≥–ª—É—à–∫–∞ —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º

### 4. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–∞ –°–µ—Ä–≤–µ—Ä–µ

–ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è:
1. –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –ë–î
2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞
3. –û–±–Ω–æ–≤–∏—Ç—å webhook —Å –Ω–æ–≤—ã–º–∏ `allowed_updates`

### 5. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

**–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞:**
- –£—Å–ø–µ—à–Ω—ã–π –∑–∞–ø—É—Å–∫ scheduler –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã
- –û—Ç–º–µ–Ω—É –∑–∞–¥–∞—á –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø
- –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Ä–∞—Å—á–µ—Ç–∞ –º–æ—Å–∫–æ–≤—Å–∫–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
- –û—à–∏–±–∫–∏ –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ gift-–∞–∫—Ç–∏–≤–∞—Ü–∏–∏

---

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –î–µ—Ç–∞–ª–∏

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- **Scheduler Service:** Redis-based –∑–∞–¥–µ—Ä–∂–∞–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏
- **Moscow Time:** UTC+3 —Ä–∞—Å—á–µ—Ç—ã –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏
- **State Machine:** –°–æ—Å—Ç–æ—è–Ω–∏—è –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞ –≤ `users.onboardingStep`
- **Gift Tokens:** –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ nanoid —Ç–æ–∫–µ–Ω—ã, –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è
- **Task Cancellation:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–º–µ–Ω–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å Gift-–ø–æ–¥–ø–∏—Å–æ–∫
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ recipient_tg_id (—Ç–æ–ª—å–∫–æ —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å)
- ‚úÖ –û–¥–Ω–æ—Ä–∞–∑–æ–≤–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è (—Ñ–ª–∞–≥ `activated`)
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ payment_id (–ø–æ–¥–∞—Ä–æ–∫ –æ–ø–ª–∞—á–µ–Ω)
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –ø–æ–¥–ø–∏—Å–∫–∏ (–Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å)

### –í—Ä–µ–º—è –û—Ç–ø—Ä–∞–≤–∫–∏
- –î–µ–Ω—å 1 (gift promo): 10:00 –ú–°–ö
- –î–Ω–∏ 7/14/21/28: 9:00 –ú–°–ö
- –î–æ–≥—Ä–µ–≤—ã –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞: –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –æ—Ç –¥–µ–π—Å—Ç–≤–∏—è

---

## üìÅ –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ –§–∞–π–ª—ã

**–°–æ–∑–¥–∞–Ω—ã:**
1. `/backend/drizzle/migrations/0003_add_onboarding_and_gift_fields.sql`
2. `/backend/src/utils/moscow-time.ts`
3. `/backend/src/modules/bot/post-payment-funnels.ts`

**–û–±–Ω–æ–≤–ª–µ–Ω—ã:**
1. `/backend/src/db/schema.ts` - –¥–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è –∏ —Ç–∞–±–ª–∏—Ü–∞
2. `/backend/src/services/scheduler.service.ts` - –Ω–æ–≤—ã–µ —Ç–∏–ø—ã –∑–∞–¥–∞—á
3. `/backend/src/modules/bot/index.ts` - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤—Å–µ—Ö –≤–æ—Ä–æ–Ω–æ–∫

---

## ‚ú® –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –¢–ó

### ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ
1. ‚úÖ –í–æ—Ä–æ–Ω–∫–∞ 1: –ö–æ–¥–æ–≤–æ–µ —Å–ª–æ–≤–æ "–£–°–ü–ï–•" —Å 3 –¥–æ–≥—Ä–µ–≤–∞–º–∏
2. ‚úÖ –í–æ—Ä–æ–Ω–∫–∞ 2: –ö–Ω–æ–ø–∫–∞ "–ì–û–¢–û–í–û" —Å 3 –¥–æ–≥—Ä–µ–≤–∞–º–∏
3. ‚úÖ –í–æ—Ä–æ–Ω–∫–∞ 3: –ú–µ–Ω—é /menu
4. ‚úÖ –í–æ—Ä–æ–Ω–∫–∞ 4: –í–æ–≤–ª–µ—á–µ–Ω–∏–µ –ø–æ –¥–Ω—è–º (1/7/14/21/28)
5. ‚úÖ –í–æ—Ä–æ–Ω–∫–∞ 5: –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –ø—Ä–æ–¥–ª–µ–Ω–∏–∏
6. ‚úÖ –í–æ—Ä–æ–Ω–∫–∞ 6: –ü–æ–¥–∞—Ä–æ—á–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞
7. ‚úÖ –í–æ—Ä–æ–Ω–∫–∞ 7: –ò—Å—Ç–µ—á–µ–Ω–∏–µ –ø–æ–¥–∞—Ä–∫–∞

### ‚è≥ –û—Ç–ª–æ–∂–µ–Ω–æ (–ø–æ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—é)
- –í–∏–¥–µ–æ-–∫—Ä—É–∂–æ–∫ (—Å—Ç—Ä–æ–∫–∞ 4)
- –í–∏–¥–µ–æ-–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è (—Å—Ç—Ä–æ–∫–∞ 92)

### üìù –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –†–µ–∞–ª–∏–∑–∞—Ü–∏–∏
- –ß–∞—Ç –≥–æ—Ä–æ–¥–∞ ‚Üí —Ä–µ–¥–∏—Ä–µ–∫—Ç –≤ —Ä–∞–∑–¥–µ–ª `/chats` –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
- –í—ã–±–æ—Ä –¥—Ä—É–≥–∞ —á–µ—Ä–µ–∑ KeyboardButtonRequestUsers (Telegram API)
- –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –ø–æ –º–æ—Å–∫–æ–≤—Å–∫–æ–º—É –≤—Ä–µ–º–µ–Ω–∏
- –ü—Ä–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ –±–æ—Ç–∞ - –ø—Ä–æ—Å—Ç–æ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è, retry –Ω–µ –¥–µ–ª–∞–µ—Ç—Å—è
- –ó–∞–¥–∞—á–∏ –Ω–µ –æ—Ç–º–µ–Ω—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ - –∏–¥—É—Ç –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é

---

## üöÄ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –î–µ–ø–ª–æ—é

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–û–¢–û–í–û –ö –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Æ –ò –î–ï–ü–õ–û–Æ

**–¢—Ä–µ–±—É–µ—Ç—Å—è:**
1. –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –ë–î
2. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ
3. –ó–∞–¥–µ–ø–ª–æ–∏—Ç—å —á–µ—Ä–µ–∑ GitHub Actions
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É –Ω–∞ –ø—Ä–æ–¥–µ

**–†–∏—Å–∫–∏:**
- –ù–µ—Ç - –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∞–¥–¥–∏—Ç–∏–≤–Ω—ã–µ, –Ω–µ –ª–æ–º–∞—é—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
- –ú–∏–≥—Ä–∞—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç `IF NOT EXISTS`)
- Backfill `first_purchase_date` —Ç–æ–ª—å–∫–æ –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö Pro –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

---

## üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è –í–æ–ø—Ä–æ—Å–æ–≤
- –¢–ó: `/egiazarova/club_webapp/migration/voronka_bot_after_pay.txt`
- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: —ç—Ç–æ—Ç —Ñ–∞–π–ª

---

**–î–∞—Ç–∞:** 2026-01-20
**–í–µ—Ä—Å–∏—è:** 1.0
**–°—Ç–∞—Ç—É—Å:** –ì–æ—Ç–æ–≤–æ –∫ –¥–µ–ø–ª–æ—é
