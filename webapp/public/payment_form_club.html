<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –ö–ª—É–± –•—Ä–∞–Ω–∏—Ç–µ–ª–µ–π</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
    }

    .container {
      max-width: 500px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    }

    h1 {
      color: #667eea;
      font-size: 24px;
      margin-bottom: 10px;
      text-align: center;
    }

    .subtitle {
      color: #666;
      font-size: 14px;
      text-align: center;
      margin-bottom: 30px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 500;
      font-size: 14px;
    }

    input[type="text"],
    input[type="email"],
    input[type="tel"] {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 16px;
      transition: border-color 0.3s;
    }

    input:focus {
      outline: none;
      border-color: #667eea;
    }

    .payment-methods {
      margin: 30px 0;
    }

    .payment-method {
      background: #f5f5f5;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 15px;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
    }

    .payment-method:hover {
      border-color: #667eea;
      background: #f8f9ff;
    }

    .payment-method.selected {
      border-color: #667eea;
      background: linear-gradient(135deg, #f8f9ff 0%, #e8ebff 100%);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
    }

    .payment-method input[type="radio"] {
      position: absolute;
      opacity: 0;
    }

    .payment-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .payment-title {
      font-size: 18px;
      font-weight: 600;
      color: #333;
    }

    .payment-price {
      font-size: 24px;
      font-weight: 700;
      color: #667eea;
    }

    .payment-description {
      color: #666;
      font-size: 14px;
      line-height: 1.4;
    }

    .submit-button {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.3s;
      margin-top: 20px;
    }

    .submit-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }

    .submit-button:active {
      transform: translateY(0);
    }

    .submit-button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .error-message {
      color: #e74c3c;
      font-size: 14px;
      margin-top: 5px;
      display: none;
    }

    .loader {
      display: none;
      text-align: center;
      margin: 20px 0;
    }

    .loader-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .success-message {
      display: none;
      text-align: center;
      padding: 20px;
    }

    .success-icon {
      font-size: 60px;
      color: #27ae60;
      margin-bottom: 15px;
    }

    .footer-note {
      text-align: center;
      margin-top: 20px;
      font-size: 12px;
      color: #999;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>‚ú® –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏</h1>
    <p class="subtitle">–ö–æ–¥ —É—Å–ø–µ—Ö–∞. –ì–ª–∞–≤–∞: –ü—Ä–æ–±—É–∂–¥–µ–Ω–∏–µ</p>

    <form id="paymentForm">
      <div class="form-group">
        <label for="name">–ò–º—è</label>
        <input type="text" id="name" name="name" required placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è">
        <div class="error-message" id="nameError">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è</div>
      </div>

      <div class="form-group">
        <label for="email">Email</label>
        <input type="email" id="email" name="email" required placeholder="example@email.com">
        <div class="error-message" id="emailError">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email</div>
      </div>

      <div class="form-group">
        <label for="phone">–¢–µ–ª–µ—Ñ–æ–Ω</label>
        <input type="tel" id="phone" name="phone" required placeholder="+7 (___) ___-__-__">
        <div class="error-message" id="phoneError">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω</div>
      </div>

      <div class="payment-methods">
        <label style="margin-bottom: 15px;">–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã:</label>

        <div class="payment-method" data-method="RUB">
          <input type="radio" name="payment_method" value="RUB" id="rub" required>
          <div class="payment-header">
            <div class="payment-title">üí≥ –ö–∞—Ä—Ç–∞ –†–§</div>
            <div class="payment-price">2.000‚ÇΩ</div>
          </div>
          <div class="payment-description">–û–ø–ª–∞—Ç–∞ –∫–∞—Ä—Ç–æ–π —Ä–æ—Å—Å–∏–π—Å–∫–æ–≥–æ –±–∞–Ω–∫–∞</div>
        </div>

        <div class="payment-method" data-method="USD">
          <input type="radio" name="payment_method" value="USD" id="usd">
          <div class="payment-header">
            <div class="payment-title">üíµ Foreign Bank USD</div>
            <div class="payment-price">26$</div>
          </div>
          <div class="payment-description">–û–ø–ª–∞—Ç–∞ –∑–∞—Ä—É–±–µ–∂–Ω–æ–π –∫–∞—Ä—Ç–æ–π –≤ –¥–æ–ª–ª–∞—Ä–∞—Ö</div>
        </div>

        <div class="payment-method" data-method="EUR">
          <input type="radio" name="payment_method" value="EUR" id="eur">
          <div class="payment-header">
            <div class="payment-title">üí∂ Foreign Bank EUR</div>
            <div class="payment-price">22‚Ç¨</div>
          </div>
          <div class="payment-description">–û–ø–ª–∞—Ç–∞ –∑–∞—Ä—É–±–µ–∂–Ω–æ–π –∫–∞—Ä—Ç–æ–π –≤ –µ–≤—Ä–æ</div>
        </div>
      </div>

      <button type="submit" class="submit-button" id="submitButton">
        –ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ
      </button>
    </form>

    <div class="loader" id="loader">
      <div class="loader-spinner"></div>
      <p style="margin-top: 15px; color: #667eea;">–§–æ—Ä–º–∏—Ä—É–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è –æ–ø–ª–∞—Ç—ã...</p>
    </div>

    <div class="success-message" id="successMessage">
      <div class="success-icon">‚úÖ</div>
      <h2>–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –æ–ø–ª–∞—Ç—É...</h2>
    </div>

    <p class="footer-note">
      –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ Lava. –í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –∑–∞—â–∏—â–µ–Ω—ã.
    </p>
  </div>

  <script>
    // Initialize Telegram WebApp
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    // Get URL parameters and UTM marks
    function getUrlParams() {
      const urlParams = new URLSearchParams(window.location.search);
      let startParam = window.Telegram?.WebApp?.initDataUnsafe?.start_param || urlParams.get('startapp') || '';

      let params = {
        utm_campaign: '',
        utm_medium: '',
        utm_source: '',
        utm_content: '',
        client_id: '',
        metka: '',
        group_id: 'hranitel_kod_bot'
      };

      // Parse startapp parameter: app_campaign_medium_source_content_clientid_groupid
      if (startParam) {
        const parts = startParam.split('_');
        if (parts.length >= 7 && parts[0] === 'app') {
          params.utm_campaign = parts[1] || '';
          params.utm_medium = parts[2] || '';
          params.utm_source = parts[3] || '';
          params.utm_content = parts[4] || '';
          params.client_id = parts[5] || '';

          // Create metka as combination of campaign and medium
          params.metka = [params.utm_campaign, params.utm_medium].filter(p => p).join('_');
        }
      }

      return params;
    }

    // Get Telegram user ID
    function getTelegramId() {
      return window.Telegram?.WebApp?.initDataUnsafe?.user?.id || null;
    }

    // Log form open event
    async function logFormOpen() {
      const telegramId = getTelegramId();
      if (!telegramId) return;

      const params = getUrlParams();

      try {
        await fetch('https://hranitel.daniillepekhin.com/api/analytics/form-open', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            telegram_id: telegramId.toString(),
            ...params
          })
        });
      } catch (error) {
        console.error('Failed to log form open:', error);
      }
    }

    // Log form open on page load
    logFormOpen();

    // Handle payment method selection
    const paymentMethods = document.querySelectorAll('.payment-method');
    paymentMethods.forEach(method => {
      method.addEventListener('click', function() {
        paymentMethods.forEach(m => m.classList.remove('selected'));
        this.classList.add('selected');
        const radio = this.querySelector('input[type="radio"]');
        radio.checked = true;
      });
    });

    // Form validation
    function validateForm() {
      let isValid = true;

      const name = document.getElementById('name').value.trim();
      const email = document.getElementById('email').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const paymentMethod = document.querySelector('input[name="payment_method"]:checked');

      // Reset error messages
      document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');

      if (!name) {
        document.getElementById('nameError').style.display = 'block';
        isValid = false;
      }

      if (!email || !email.includes('@')) {
        document.getElementById('emailError').style.display = 'block';
        isValid = false;
      }

      if (!phone) {
        document.getElementById('phoneError').style.display = 'block';
        isValid = false;
      }

      if (!paymentMethod) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã');
        isValid = false;
      }

      return isValid;
    }

    // Generate payment link
    async function generatePaymentLink(formData, paymentMethod) {
      const telegramId = getTelegramId();
      const params = getUrlParams();

      const payload = {
        email: formData.email,
        name: formData.name,
        phone: formData.phone,
        payment_method: paymentMethod,
        telegram_id: telegramId ? telegramId.toString() : null,
        source: 'telegram_webapp',
        tariff: 'club2000',
        ...params
      };

      // Log payment attempt
      try {
        await fetch('https://hranitel.daniillepekhin.com/api/analytics/payment-attempt', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            telegram_id: telegramId ? telegramId.toString() : null,
            payment_method: paymentMethod,
            amount: paymentMethod === 'RUB' ? '2000' : (paymentMethod === 'USD' ? '26' : '22'),
            currency: paymentMethod,
            ...params
          })
        });
      } catch (error) {
        console.error('Failed to log payment attempt:', error);
      }

      // Generate payment link via n8n webhook
      const response = await fetch('https://n8n4.daniillepekhin.ru/webhook/lava_club2', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (!response.ok) {
        throw new Error('Failed to generate payment link');
      }

      const data = await response.json();

      // Handle both array and object response formats
      let paymentUrl = Array.isArray(data) ? data[0].paymentUrl : data.paymentUrl;

      return paymentUrl;
    }

    // Handle form submission
    document.getElementById('paymentForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      if (!validateForm()) {
        return;
      }

      const formData = {
        name: document.getElementById('name').value.trim(),
        email: document.getElementById('email').value.trim(),
        phone: document.getElementById('phone').value.trim()
      };

      const paymentMethod = document.querySelector('input[name="payment_method"]:checked').value;

      // Show loader
      document.getElementById('paymentForm').style.display = 'none';
      document.getElementById('loader').style.display = 'block';
      document.getElementById('submitButton').disabled = true;

      try {
        const paymentUrl = await generatePaymentLink(formData, paymentMethod);

        // Show success message
        document.getElementById('loader').style.display = 'none';
        document.getElementById('successMessage').style.display = 'block';

        // Redirect to payment page
        setTimeout(() => {
          window.location.href = paymentUrl;
        }, 1000);

      } catch (error) {
        console.error('Payment error:', error);
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å—Å—ã–ª–∫–∏ –Ω–∞ –æ–ø–ª–∞—Ç—É. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');

        // Reset form
        document.getElementById('loader').style.display = 'none';
        document.getElementById('paymentForm').style.display = 'block';
        document.getElementById('submitButton').disabled = false;
      }
    });

    // Phone formatting
    document.getElementById('phone').addEventListener('input', function(e) {
      let value = e.target.value.replace(/\D/g, '');

      if (value.length > 0) {
        if (value[0] === '7' || value[0] === '8') {
          value = '7' + value.substring(1);
        } else if (value[0] !== '7') {
          value = '7' + value;
        }
      }

      let formatted = '+7';
      if (value.length > 1) {
        formatted += ' (' + value.substring(1, 4);
      }
      if (value.length >= 4) {
        formatted += ') ' + value.substring(4, 7);
      }
      if (value.length >= 7) {
        formatted += '-' + value.substring(7, 9);
      }
      if (value.length >= 9) {
        formatted += '-' + value.substring(9, 11);
      }

      e.target.value = formatted;
    });
  </script>
</body>
</html>
