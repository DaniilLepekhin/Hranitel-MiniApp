import { Bot, InlineKeyboard } from 'grammy';
import postgres from 'postgres';

const BOT_TOKEN = process.env.TELEGRAM_BOT_TOKEN || '';
const bot = new Bot(BOT_TOKEN);

// –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
const db = postgres({
  host: '31.128.36.81',
  port: 5423,
  database: 'club_hranitel',
  username: 'postgres',
  password: 'kH*kyrS&9z7K',
  ssl: false,
});

const mariaTelegramId = 1968590658;
const chatId = mariaTelegramId;

async function activateMaria() {
  console.log('üîÑ –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –ú–∞—Ä–∏—é (–¥–æ—á—å)...');

  // 1. –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø–æ–¥–ø–∏—Å–∫—É
  const expiresDate = new Date();
  expiresDate.setDate(expiresDate.getDate() + 30); // +30 –¥–Ω–µ–π

  await db`
    UPDATE users
    SET
      is_pro = true,
      subscription_expires = ${expiresDate.toISOString()},
      onboarding_step = 'awaiting_keyword',
      updated_at = NOW()
    WHERE telegram_id = ${mariaTelegramId}
  `;

  console.log(`‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ –¥–æ ${expiresDate.toISOString()}`);

  // 2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É /menu
  try {
    await bot.api.setMyCommands(
      [{ command: 'menu', description: '–û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é –∫–ª—É–±–∞' }],
      { scope: { type: 'chat', chat_id: chatId } }
    );
    console.log('‚úÖ –ö–æ–º–∞–Ω–¥–∞ /menu —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–æ–º–∞–Ω–¥—ã:', error);
  }

  // 3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É –º–µ–Ω—é
  try {
    await bot.api.setChatMenuButton({
      chat_id: chatId,
      menu_button: { type: 'commands' }
    });
    console.log('‚úÖ –ö–Ω–æ–ø–∫–∞ –º–µ–Ω—é —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–Ω–æ–ø–∫–∏:', error);
  }

  // 4. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ –≤–∏–¥–µ–æ —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π
  try {
    await bot.api.sendVideo(
      chatId,
      'https://t.me/mate_bot_open/9644',
      {
        caption:
          `¬´–ü—Ä–∏–≤–µ—Ç, –ú–∞—Ä–∏—è! üéâ\n\n` +
          `–¢—ã –Ω–∞—á–∏–Ω–∞–µ—à—å –ø–æ–≥—Ä—É–∂–µ–Ω–∏–µ –≤ <b>¬´–ö–æ–¥ —É—Å–ø–µ—Ö–∞. –ì–ª–∞–≤–∞: –ü—Ä–æ–±—É–∂–¥–µ–Ω–∏–µ¬ª</b> ‚ú®\n\n` +
          `–ß—Ç–æ–±—ã –¥–≤–µ—Ä–∏ –Ω–∞—à–µ–π —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã –æ—Ç–∫—Ä—ã–ª–∏—Å—å, —Ç–µ–±–µ –Ω—É–∂–Ω–æ –ø—Ä–∏–Ω—è—Ç—å –µ—ë –ø—Ä–∞–≤–∏–ª–∞.\n\n` +
          `üé• –ü–æ—Å–º–æ—Ç—Ä–∏ –≤–∏–¥–µ–æ –ö—Ä–∏—Å—Ç–∏–Ω—ã <b>–¥–æ —Å–∞–º–æ–≥–æ –∫–æ–Ω—Ü–∞.</b> –ö—Ä–∏—Å—Ç–∏–Ω–∞ —Ä–∞—Å—Å–∫–∞–∂–µ—Ç, –∫–∞–∫ —É—Å—Ç—Ä–æ–µ–Ω–∞ –Ω–∞—à–∞ –í—Å–µ–ª–µ–Ω–Ω–∞—è: –≥–¥–µ –∏—Å–∫–∞—Ç—å –∫–ª—é—á–∏, –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—É–ø–µ—Ä-–∞–ø–ø –∏ –∫–∞–∫ –Ω–∞–π—Ç–∏ —Å–≤–æ—é —Å—Ç–∞—é üòÑ (—á–∞—Ç—ã –≥–æ—Ä–æ–¥–æ–≤ –∏ –¥–µ—Å—è—Ç–∫–∏).\n\n` +
          `<b>üóù –í–Ω–∏–º–∞–Ω–∏–µ: –≤–Ω—É—Ç—Ä–∏ –≤–∏–¥–µ–æ —Å–ø—Ä—è—Ç–∞–Ω —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –ö–ª—é—á (–∫–æ–¥–æ–≤–æ–µ —Å–ª–æ–≤–æ). –ë–µ–∑ –Ω–µ–≥–æ —è –Ω–µ —Å–º–æ–≥—É –≤—ã–¥–∞—Ç—å —Ç–µ–±–µ –¥–æ—Å—Ç—É–ø—ã –∫ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º –∏ –∑–∞–∫—Ä—ã—Ç—ã–º —á–∞—Ç–∞–º.</b>\n\n` +
          `–°–º–æ—Ç—Ä–∏ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ. <i>–ö–∞–∫ —Ç–æ–ª—å–∫–æ —É—Å–ª—ã—à–∏—à—å —Å–ª–æ–≤–æ ‚Äî –ø–∏—à–∏ –µ–≥–æ –º–Ω–µ –≤ –æ—Ç–≤–µ—Ç üëáüèº</i>¬ª`,
        parse_mode: 'HTML'
      }
    );
    console.log('‚úÖ –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ –≤–∏–¥–µ–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤–∏–¥–µ–æ:', error);
  }

  // 5. –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –º–∞—Ç–µ—Ä–∏
  try {
    await bot.api.sendMessage(
      1499306483, // –°–≤–µ—Ç–ª–∞–Ω–∞
      `‚úÖ <b>–ü–æ–¥–ø–∏—Å–∫–∞ –¥–ª—è –ú–∞—Ä–∏–∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞!</b>\n\n` +
      `–ú–∞—Ä–∏—è (@marimdna) —Ç–µ–ø–µ—Ä—å –º–æ–∂–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º.\n\n` +
      `–ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞ –¥–æ: ${expiresDate.toLocaleDateString('ru-RU')}\n\n` +
      `–Ø –æ—Ç–ø—Ä–∞–≤–∏–ª –µ–π –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã üéâ`,
      { parse_mode: 'HTML' }
    );
    console.log('‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –º–∞—Ç–µ—Ä–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:', error);
  }

  console.log('‚úÖ –ê–∫—Ç–∏–≤–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!');
  await db.end();
  process.exit(0);
}

activateMaria().catch(console.error);
